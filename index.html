<!doctype html>
<html>
<head>
    <meta charset=utf-8>
    <meta name=description content="">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title>Jquery Comments Plugin</title>

    <!-- Styles -->
    <link rel="stylesheet" type="text/css" href="css/jquery-comments.css">
    <link rel="stylesheet" type="text/css"
          href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <!-- Data -->
    <script type="text/javascript" src="data/comments-data.js"></script>

    <!-- Libraries -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery.textcomplete/1.8.0/jquery.textcomplete.js"></script>
    <script type="text/javascript" src="js/jquery-comments.js"></script>

    <style type="text/css">
        body {
            padding: 20px;
            margin: 0px;
            font-size: 14px;
            font-family: "Arial", Georgia, Serif;
        }
    </style>

    <!-- Init jquery-comments -->
    <script type="text/javascript">
        $(function () {
            var notZero = function (parentId) {
                if (parentId === null) {
                    return null
                }
                if (parentId === 0) {
                    return null
                }
                return parentId;
            };

            // 映射字段
            var fieldMappings = function (data) {
                return {
                    "id": data.id,
                    "parent": notZero(data.parentId),
                    // "parent": null,
                    "created": data.createTime,
                    "modified": data.createTime,
                    "content": data.content,
                    "attachments": [],
                    "pings": [],
                    "creator": data.author,
                    "fullname": data.author,
                    "profile_picture_url": data.avatar,
                    "created_by_admin": data.isAdmin,
                    "created_by_current_user": false,
                    "upvote_count": 0,
                    "user_has_upvoted": false,
                    "is_new": false,
                    "children": data.children,
                }
            };

            // 解析内容
            var parseContent = function (content) {
                if (content === null || content === undefined) {
                    return [];
                }
                if (content.children === null || content.children.length < 1) {
                    return [fieldMappings(content)]
                }
                const comments = [];
                var comment = fieldMappings(content)
                comments.push(comment)
                var childComments = []
                for (let i = 0; i < comment.children.length; i++) {
                    var childComment = parseContent(comment.children[i]);
                    childComments.push(...childComment)
                }
                comments.push(...childComments)
                return comments;
            };

            // 映射json
            var fieldMappingJSON = function (data) {
                return {
                    "allowNotification": true,
                    "author": "test",
                    "content": data.content,
                    "email": "test@mail.com",
                    "parentId": data.parent,
                    "postId": 1
                };
            };


            usersArray = [];
            var doGetComment = function (success, error) {
                $.ajax({
                    url: 'http://localhost:8090/api/content/posts/1/comments/tree_view',
                    type: 'GET',
                    success: function (data, textStatus, xhr) {
                        const {data: {content}} = data;
                        var commentsArray = [];
                        content.forEach(c => {
                            usersArray.push({fullname: c.author, email: c.email})
                            commentsArray.push(...parseContent(c))
                        })
                        success(commentsArray)
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        commentsArray = []
                    }
                });
            };


            var doPostComment = function (data, success, error, audit) {
                const jsonData = fieldMappingJSON(data)
                $.ajax({
                    url: 'http://localhost:8090/api/content/posts/comments',
                    type: 'POST',
                    contentType: "application/json",
                    async: false,
                    dataType: "json",
                    data: JSON.stringify(jsonData),
                    success: function (data, textStatus, xhr) {
                        const {status} = data.data
                        // if ("AUDITING" === status) {
                        //     audit();
                        // }
                        success(fieldMappings({parent: null, ...data.data}), "AUDITING" === status);
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        error()
                    }
                });
            };

            var saveComment = function (data) {
                // Convert pings to human readable format
                $(Object.keys(data.pings)).each(function (index, userId) {
                    var fullname = data.pings[userId];
                    var pingText = '@' + fullname;
                    data.content = data.content.replace(new RegExp('@' + userId, 'g'), pingText);
                });
                return data;
            }
            $('#comments-container').comments({
                profilePictureURL: 'https://viima-app.s3.amazonaws.com/media/public/defaults/user-icon.png',
                currentUserId: 1,
                roundProfilePictures: true,
                textareaRows: 1,
                enableAttachments: true,
                enableHashtags: true,
                enablePinging: true,
                scrollContainer: $(window),
                searchUsers: function (term, success, error) {
                    setTimeout(function () {
                        success(usersArray.filter(function (user) {
                            var containsSearchTerm = user.fullname.toLowerCase().indexOf(term.toLowerCase()) != -1;
                            var isNotSelf = user.email != 1;
                            return containsSearchTerm && true;
                        }));
                    }, 500);
                },
                getComments: function (success, error) {
                    setTimeout(function () {
                        doGetComment(success, error);
                    }, 500);
                },
                postComment: function (data, success, error, audit) {
                    setTimeout(function () {
                        doPostComment(data, success, error, audit);
                    }, 500);
                },
                putComment: function (data, success, error) {
                    setTimeout(function () {
                        success(saveComment(data));
                    }, 500);
                },
                deleteComment: function (data, success, error) {
                    setTimeout(function () {
                        success();
                    }, 500);
                },
                upvoteComment: function (data, success, error) {
                    setTimeout(function () {
                        success(data);
                    }, 500);
                },
                validateAttachments: function (attachments, callback) {
                    setTimeout(function () {
                        callback(attachments);
                    }, 500);
                },
            });
        });
    </script>

</head>
<body>
<div id="comments-container"></div>
</body>
</html>
